<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提交图片</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
</head>
<body class="m-5">
    <div class="container">
        <div class="col"><a href="{% url 'gallery' %}" class="btn btn-dark my-3">GO back</a></div>
        <div class="row justify-content-center">


            <div class="col-md-5 ">
                <!-- 添加enctype属性才能上传文件 -->
                <form method="post" class="m-3" enctype="multipart/form-data" id="imageUploadForm">
                    {% csrf_token %}
                    
                    <!-- 文件上传 -->
                    <div class=" m-3" >
                        <label class="form-label">上传图片</label>
                        <input type="file"  name="image" class="form-control" id="inputGroupFile04" aria-describedby="inputGroupFileAddon04" aria-label="Upload" required>
                    </div>

                    <!-- 下拉框 -->
                     <div class="m-3">
                     <label class="form-label">分类</label>
                    <select name="category" class=" form-select" aria-label="Default select example" id="categorySelect">
                        <option value="">请选择分类</option>
                    {% for categor in data %}
                        <option value="{{ categor.id }}">{{categor.photos_name}}</option>
                    {% endfor %}
                    </select>
                    </div>

                    <!-- 图片描述 -->
                    <div class="m-3">
                        <label for="description" class="form-label">图片描述</label>
                        <textarea name="description" id="description" class="form-control" rows="3"></textarea>
                    </div>

                    <!-- 创建一个新的分类 -->
                    <div class="m-3" id="newCategoryDiv" style="display: block;">
                        <label class="form-label">新分类名称</label>
                        <input name="category_new" type="text" placeholder="请输入新分类名称" class="form-control" id="newCategoryInput">
                    </div>
                        
                    <button class="btn btn-dark m-3" type="submit" >确定上传</button>
                </form>
            </div>

            <div class="col-md-5 ">
                <div class="row justify-content-center">
                    <!-- 图片预览区域 -->
                    <div id="imagePreview" style=""> 
                        <h5>图片预览:</h5>
                        <img id="preview" src="#" alt="图片预览" class="img-fluid rounded" style="max-height: 400px; display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// 获取DOM元素
const categorySelect = document.getElementById('categorySelect');
const newCategoryDiv = document.getElementById('newCategoryDiv');
const newCategoryInput = document.getElementById('newCategoryInput');
const imageInput = document.getElementById('inputGroupFile04');
const previewImage = document.getElementById('preview');
const uploadForm = document.getElementById('imageUploadForm');

// 1. 分类选择框变化事件：控制新分类输入框的显示/隐藏，并清空新分类值
categorySelect.addEventListener('change', function() {
    if (this.value === '') {
        // 未选择分类：显示新分类输入框
        newCategoryDiv.style.display = 'block';
    } else {
        // 选择了已有分类：隐藏新分类输入框，并清空其值（关键！避免同时提交）
        newCategoryDiv.style.display = 'none';
        newCategoryInput.value = '';
    }
});

// 2. 新分类输入框事件：输入内容时，自动清空分类选择框（关键！确保互斥）
newCategoryInput.addEventListener('input', function() {
    if (this.value.trim() !== '') {
        // 输入了新分类名称：强制选择框为「未选择」状态
        categorySelect.value = '';
        newCategoryDiv.style.display = 'block'; // 确保输入框显示
    }
});

// 3. 图片预览优化：默认隐藏预览图，选择图片后显示
imageInput.addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            previewImage.style.display = 'block'; // 显示预览图
        }
        reader.readAsDataURL(file);
    } else {
        previewImage.style.display = 'none'; // 未选择图片时隐藏
        previewImage.src = '#';
    }
});

// 4. 表单提交验证：确保分类参数合法（关键！避免后端接收异常数据）
uploadForm.addEventListener('submit', function(e) {
    const selectedCategory = categorySelect.value.trim();
    const newCategoryName = newCategoryInput.value.trim();
    const imageFile = imageInput.files[0];

    // 验证1：必须选择图片
    if (!imageFile) {
        alert('请先上传图片！');
        e.preventDefault(); // 阻止表单提交
        return;
    }

    // 验证2：分类必须二选一（要么选已有分类，要么输新分类）
    if (!selectedCategory && !newCategoryName) {
        alert('请选择已有分类，或输入新分类名称！');
        e.preventDefault();
        return;
    }

    // 验证3：不能同时选择已有分类和输入新分类（理论上被前面逻辑阻止，但加一层保险）
    if (selectedCategory && newCategoryName) {
        alert('只能选择已有分类或创建新分类，不可同时操作！');
        e.preventDefault();
        return;
    }
});
</script>

</body>
</html>